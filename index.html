<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
	<title>PWA Background Synchronization and Fetch Demo</title>
    <link rel="icon" type="image/png" sizes="36x36" href="./favicon.png">
</head>
<body>
    <h1>Results ...</h1>
    <ul id="results">
    </ul>
    <script>
        function report(result) {
            console.log(result);
            const ul = document.getElementById('results');
            const li = document.createElement('li');
            li.innerText = result;
            ul.appendChild(li);
        }

        function check(parent_name, parent_value, child_name, body = undefined) {
            if (child_name in parent_value) {
                const child = parent_value[child_name];
                if (child) {
                    report(`"${parent_name}.${child_name}" has a value`);
                    return body ? body(child) : undefined;
                } else {
                    report(`"${parent_name}.${child_name}" is null or undefined`);
                }
            } else {
                report(`"${parent_name}" does not contain "${child_name}"`);
            }
        }

        const services = {};

        async function check_capabilities() {
            await check('navigator', navigator, 'storage', async storage => {
                services.storage = storage;
                await check('navigator.storage', storage, 'estimate', async estimate => {
                    services.estimate = await storage.estimate();
                });
            });

            check('navigator', navigator, 'serviceWorker', serviceWorker => {
                services.serviceWorker = serviceWorker;
            });
        }

        async function check_storage_quota() {
            if (services.estimate) {
                const percentageUsed = (services.estimate.usage / services.estimate.quota) * 100;
                const remaining = services.estimate.quota - services.estimate.usage;
                report(`Storage estimate: ${percentageUsed.toFixed(1)}% used, ${remaining.toLocaleString()} bytes available`);
            }
        }

        let registration = undefined;

        function register_service_worker() {
            console.log('register_service_worker: enter');
            return new Promise(resolve => {
                console.log('register_service_worker: running promise');
                if (services.serviceWorker) {
                    console.log('register_service_worker: listening for load event');
                    window.addEventListener('load', async () => {
                        console.log('register_service_worker: load event received, registering service worker');
                        registration = await services.serviceWorker.register('./sw.js');
                        if (!registration) {
                            report('"navigator.serviceWorker.register" returned null or undefined');
                        } else {
                            report('service worker registered');
                            check('registration', registration, 'periodicSync');
                            check('registration', registration, 'backgroundFetch');
                            check('registration', registration, 'pushManager');
                            check('registration', registration, 'sync');
                            check('registration', registration, 'index');
                        }
                        console.log('register_service_worker: resolving promise (1)');
                        resolve();
                    });
                } else {
                    console.log('register_service_worker: resolving promise (2)');
                    resolve();
                }
            });
        }

        let periodic_sync_registered = false;

        async function try_register_periodic_sync() {
            if (!periodic_sync_registered) {
                try {
                    await periodicSync.register(`content-sync`, {
                        minInterval: 60 * 60 * 1000, // 1 hour
                    });
                    report(`periodic sync registered`);
                    periodic_sync_registered = true;
                } catch (e) {
                    report(`periodic sync failed to register: ${e}`);
                }
            }
        }

        async function register_periodic_sync() {
            if (registration.periodicSync) {
                const status = await navigator.permissions.query({
                    name: 'periodic-background-sync'
                });
                if (status) {
                    report(`"periodic-background-sync" permission status state: ${status.state}`);
                    if (status.state === 'granted') {
                        await try_register_periodic_sync();
                    }
                    status.onchange = async () => {
                        report(`"periodic-background-sync" permission status state changed: ${status.state}`);
                        if (status.state === 'granted') {
                            await try_register_periodic_sync();
                        }
                    };
                } else {
                    report('"periodic-background-sync" permission status is null or undefined');
                }
            }
        }

        async function main() {
            await check_capabilities();
            await check_storage_quota();
            await register_service_worker();
            await register_periodic_sync();
        }

        main();
	</script>
</body>
