<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
	<title>PWA Background Synchronization and Fetch Demo</title>
    <link rel="icon" type="image/png" sizes="36x36" href="./favicon.png">
</head>
<body>
    <h1>Results ...</h1>
    <ul id="results">
    </ul>
    <script>
        function report(result) {
            console.log(result);
            const ul = document.getElementById('results');
            const li = document.createElement('li');
            li.innerText = result;
            ul.appendChild(li);
        }

        function check(parent_name, parent_value, child_name, body) {
            if (child_name in parent_value) {
                const child = parent_value[child_name];
                if (child) {
                    return body(child);
                } else {
                    report(`"${parent_name}.${child_name}" is null or undefined`);
                }
            } else {
                report(`"${parent_name}" does not contain "${child_name}"`);
            }
        }

        async function register_periodic_sync(periodicSync) {
            try {
                await periodicSync.register(`content-sync`, {
                    minInterval: 60 * 60 * 1000, // 1 hour
                });
                report(`periodic sync registered`);
            } catch (e) {
                report(`periodic sync failed to register: ${e}`);
            }
        }

        // Ask for periodic background sync permissions
        navigator.permissions.query({ name: 'periodic-background-sync' })
        .then(status => {
            if (status) {
                report(`"periodic-background-sync" permission status state: ${status.state}`);
                status.onchange = () => {
                    report(`"periodic-background-sync" permission status state changed: ${status.state}`);
                }                
            } else {
                report('"periodic-background-sync" permission status is null or undefined');
            }
        });

        // Check the browser's storage quota
        // See: https://web.dev/storage-for-the-web/#check
        check('navigator', navigator, 'storage', storage => {
            check('navigator.storage', storage, 'estimate', estimate => {
                navigator.storage.estimate().then(quota => {
                    // quota.usage -> Number of bytes used.
                    // quota.quota -> Maximum number of bytes available.
                    const percentageUsed = (quota.usage / quota.quota) * 100;
                    report(`Storage quota estimate: you've used ${percentageUsed}% of the available storage`);
                    const remaining = quota.quota - quota.usage;
                    report(`Storage quota estimate: you can write up to ${remaining} more bytes`);
                });
            });
        });

        // Check for service worker support and install the service worker
        let registration;
        check('navigator', navigator, 'serviceWorker', serviceWorker => {
            window.addEventListener("load", () => {
                serviceWorker.register("./sw.js").then(result => {
                    if (!result) {
                        report('"navigator.serviceWorker.register" returned null or undefined');
                    } else {
                        report('service worker registered');
                        registration = result;
                        if (result.periodicSync) {
                            register_periodic_sync(result.periodicSync);
                        } else {
                            report('"registration.periodicSync" is null or undefined');
                        }
                        if (!result.backgroundFetch) {
                            report('"registration.backgroundFetch" is null or undefined');
                        }
                        if (!result.pushManager) {
                            report('"registration.pushManager" is null or undefined');
                        }
                        if (!result.sync) {
                            report('"registration.sync" is null or undefined');
                        }
                        if (!result.index) {
                            report('"registration.index" is null or undefined');
                        }
                    }
                });
            });
        });
	</script>
</body>
