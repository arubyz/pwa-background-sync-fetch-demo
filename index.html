<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
	<title>PWA Background Synchronization and Fetch Demo</title>
    <link rel="icon" type="image/png" sizes="36x36" href="./favicon.png">
</head>
<body>
    <h1>Results ...</h1>
    <ul id="results">
    </ul>
    <script>
        function report(result) {
            console.log(result);
            const ul = document.getElementById('results');
            const li = document.createElement('li');
            li.innerText = result;
            ul.appendChild(li);
        }

        function check(parent_name, parent_value, child_name, body) {
            if (child_name in parent_value) {
                const child = parent_value[child_name];
                if (child) {
                    return body(child);
                } else {
                    report(`"${parent_name}.${child_name}" is null or undefined`);
                }
            } else {
                report(`"${parent_name}" does not contain "${child_name}"`);
            }
        }

        // Check the browser's storage quota
        // See: https://web.dev/storage-for-the-web/#check
        check('navigator', navigator, 'storage', storage => {
            check('navigator.storage', storage, 'estimate', estimate => {
                navigator.storage.estimate().then(quota => {
                    // quota.usage -> Number of bytes used.
                    // quota.quota -> Maximum number of bytes available.
                    const percentageUsed = (quota.usage / quota.quota) * 100;
                    report(`Storage quota estimate: you've used ${percentageUsed}% of the available storage`);
                    const remaining = quota.quota - quota.usage;
                    report(`Storage quota estimate: you can write up to ${remaining} more bytes`);
                });
            });
        });

        // Check for service worker support and install the service worker
        let registration;
        check('navigator', navigator, 'serviceWorker', serviceWorker => {
            window.addEventListener("load", () => {
                serviceWorker.register("./sw.js").then(result => {
                    if (!result) {
                        report('"navigator.serviceWorker.register" returned null or undefined');
                    } else {
                        report('service worker registered');
                        registration = result;
                        if (!result.backgroundFetch) {
                            report('"registration.backgroundFetch" is null or undefined');
                        }
                        if (!result.pushManager) {
                            report('"registration.pushManager" is null or undefined');
                        }
                        if (!result.sync) {
                            report('"registration.sync" is null or undefined');
                        }
                        if (!result.index) {
                            report('"registration.index" is null or undefined');
                        }
                    }
                });
            });
        });
	</script>
</body>
